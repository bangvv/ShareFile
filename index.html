<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Local Send File Pro</title>
    <meta name="description" content="G·ª≠i file kh√¥ng gi·ªõi h·∫°n dung l∆∞·ª£ng qua m·∫°ng n·ªôi b·ªô v√† Internet. B·∫£o m·∫≠t P2P, t·ªëc ƒë·ªô cao, kh√¥ng c·∫ßn c√†i ƒë·∫∑t.">
    <meta name="keywords" content="g·ª≠i file nhanh, chuy·ªÉn d·ªØ li·ªáu, p2p file transfer, local send, g·ª≠i file l·ªõn">
    <meta name="author" content="LocalSendPro">
    
    <link rel="icon" type="image/png" href="image/icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://unpkg.com/simple-peer@9/simplepeer.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
    :root { 
        --primary: #3b82f6; 
        --primary-hover: #2563eb;
        --success: #10b981; 
        --bg: #0b0f1a; 
        --card: rgba(30, 41, 59, 0.75); 
        --text: #f8fafc; 
    }

    * { 
        box-sizing: border-box; 
        -webkit-tap-highlight-color: transparent;
        font-family: 'Inter', -apple-system, system-ui, sans-serif; 
    }

    /* Kh√≥a scroll to√†n m√†n h√¨nh tr√™n c·∫£ PC v√† Mobile */
    html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; 
        position: fixed;
    }

    body { 
        background: radial-gradient(circle at 50% 0%, #1e293b 0%, #0b0f1a 100%); 
        color: var(--text); 
        display: flex; 
        align-items: center; 
        justify-content: center;
        padding: 15px;
    }

    /* Card lu√¥n n·∫±m gi·ªØa v√† kh√¥ng bao gi·ªù qu√° cao */
    .card { 
        width: 100%; 
        max-width: 480px; 
        max-height: 95vh; /* Gi·ªõi h·∫°n chi·ªÅu cao card */
        background: var(--card); 
        padding: 24px; 
        border-radius: 32px; 
        border: 1px solid rgba(255, 255, 255, 0.1); 
        box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        display: flex;
        flex-direction: column; /* Chia card th√†nh c√°c ph·∫ßn d·ªçc */
    }

    h2 { 
        margin: 0 0 15px; 
        font-size: 1.4rem; 
        background: linear-gradient(135deg, #93c5fd, #3b82f6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center; 
        font-weight: 800;
        flex-shrink: 0; /* Kh√¥ng b·ªã b√≥p m√©o khi m√†n h√¨nh nh·ªè */
    }

    /* V√πng ch·ª©a c√°c th√¥ng b√°o tr·∫°ng th√°i */
    .status-container { flex-shrink: 0; }

    #status-text, #status-devices { 
        text-align: center; font-size: 0.8rem; font-weight: 600; 
        margin-bottom: 10px; padding: 10px; border-radius: 12px;
        background: rgba(59, 130, 246, 0.1); color: var(--primary);
        animation: pulse 2s infinite;
    }

    .name-box { margin-bottom: 15px; position: relative; flex-shrink: 0; }
    .name-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
    .name-box input { 
        width: 100%; background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; 
        color: white; padding: 12px 15px 12px 40px; border-radius: 14px; 
        outline: none; font-size: 16px; /* Ch·∫∑n auto-zoom tr√™n iPhone */
    }

    /* V√ôNG CU·ªòN DUY NH·∫§T: Danh s√°ch thi·∫øt b·ªã */
    .device-list { 
        margin-bottom: 15px; 
        display: grid; 
        gap: 10px; 
        overflow-y: auto; /* Ch·ªâ cho ph√©p cu·ªôn t·∫°i ƒë√¢y */
        padding-right: 5px;
        flex-grow: 1; /* T·ª± ƒë·ªông d√£n ƒë·ªÉ chi·∫øm kh√¥ng gian tr·ªëng */
    }
    
    /* Custom Scrollbar cho danh s√°ch thi·∫øt b·ªã */
    .device-list::-webkit-scrollbar { width: 4px; }
    .device-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        .device-item { padding: 16px; background: #0f172a; border-radius: 16px; border: 1px solid #334155; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: 0.2s; }
        .device-item:active { transform: scale(0.97); background: #1e293b; }
        .device-info { display: flex; align-items: center; gap: 15px; }
        .device-icon { font-size: 1.8rem; background: #1e293b; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
        .device-name-text b { display: block; font-size: 1rem; color: #fff; }
        .device-name-text span { font-size: 0.75rem; color: #64748b; }
		

    /* File Box v√† N√∫t G·ª≠i lu√¥n n·∫±m c·ªë ƒë·ªãnh ·ªü d∆∞·ªõi Card */
    .file-box { 
        border: 2px dashed #475569; padding: 15px; 
        text-align: center; border-radius: 20px; 
        background: rgba(255,255,255,0.02); margin-top: auto; flex-shrink: 0;
    }
    #file-info { font-size: 0.75rem; color: #94a3b8; margin-bottom: 10px; }

    .btn-upload { 
        background: var(--primary); color: white; padding: 14px; 
        border-radius: 14px; cursor: pointer; font-weight: 700; 
        display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem;
    }
    
	.progress-container { display: none; margin-top: 25px; background: #0f172a; padding: 20px; border-radius: 18px; border: 1px solid #334155; }
	.progress-bg { width: 100%; height: 12px; background: #334155; border-radius: 6px; overflow: hidden; margin-bottom: 12px; }
	.progress-bar { width: 0%; height: 100%; background: var(--primary); border-radius: 6px; transition: width 0.1s linear; }
	.stats { display: flex; justify-content: space-between; font-family: monospace; font-size: 0.95rem; font-weight: 700; }
	#cur-file { font-size: 0.8rem; color: var(--primary); margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .footer-info {
        position: absolute; bottom: 10px; width: 100%; text-align: center;
        font-size: 0.7rem; color: #64748b; padding: 0 10px; pointer-events: none;
    }

    @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
</style>
</head>
<body>

<div class="card">
    <h2><i class="fas fa-paper-plane"></i> Local Send Pro</h2>
    
    <div class="name-box">
        <i class="fas fa-user"></i>
        <input type="text" id="userName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." maxlength="20">
    </div>
	
	<div id="status-text"><i class="fas fa-circle-notch fa-spin"></i> ƒêang ki·ªÉm tra IP</div>
	
    <div id="status-devices"><i class="fas fa-circle-notch fa-spin"></i> ƒêang t√¨m ki·∫øm thi·∫øt b·ªã xung quanh...</div>
    
    <div class="device-list" id="devices">
        <div class="device-item">

        </div>
    </div>

    <div class="file-box">
        <div id="file-info"><i class="fas fa-info-circle"></i> Ch·ªçn file ƒë·ªÉ b·∫Øt ƒë·∫ßu chia s·∫ª</div>
        <label class="btn-upload">
            <i class="fas fa-cloud-upload-alt"></i> 
            <input type="file" id="fileInput" multiple>
        </label>
    </div>

    <div class="progress-container" id="progCont">
        <div id="cur-file"></div>
        <div class="progress-bg"><div class="progress-bar" id="bar"></div></div>
        <div class="stats">
            <span id="percent">0%</span>
            <span id="speed">0.0 MB/s</span>
        </div>
    </div>
</div>

<div class="footer-info">
    <p><b>Local Send File Pro</b> - Gi·∫£i ph√°p chuy·ªÉn d·ªØ li·ªáu P2P b·∫£o m·∫≠t.<br>
    Kh√¥ng l∆∞u tr·ªØ file tr√™n server, t·ªëc ƒë·ªô truy·ªÅn t·∫£i t·ªëi ƒëa theo ƒë∆∞·ªùng truy·ªÅn m·∫°ng c·ªßa b·∫°n.</p>
</div>

<script src="firebase-config.js"></script>

<script>
const myId = Math.random().toString(36).slice(2, 8);
let myIP = "", peer = null, startTime = 0, meta = null, receivedSize = 0, isNextReady = false;
let targetId = null; // L∆∞u ID thi·∫øt b·ªã ƒëang k·∫øt n·ªëi

const UI = {
    status: document.getElementById('status-text'),
    devices: document.getElementById('devices'),
    file: document.getElementById('fileInput'),
    bar: document.getElementById('bar'),
    percent: document.getElementById('percent'),
    speed: document.getElementById('speed'),
    prog: document.getElementById('progCont'),
    name: document.getElementById('userName'),
    curFile: document.getElementById('cur-file'),
    fileInfo: document.getElementById('file-info')
};

const getDevice = () => {
    const ua = navigator.userAgent;
    if (/android/i.test(ua)) return { icon: "ü§ñ", type: "Android" };
    if (/iPad|iPhone|iPod/.test(ua)) return { icon: "üçé", type: "iPhone" };
    if (/Windows/i.test(ua)) return { icon: "üíª", type: "Windows PC" };
    return { icon: "üåê", type: "Thi·∫øt b·ªã" };
};
const dev = getDevice();
UI.name.value = localStorage.getItem('lan_name') || (dev.type + " " + myId);

function updateProfile() {
    if (!myIP || !db) return;
    const name = UI.name.value || (dev.type + " " + myId);
    localStorage.setItem('lan_name', name);
    
    // Ghi ƒë√® l√™n Firebase ƒë·ªÉ b√°o hi·ªáu thi·∫øt b·ªã v·∫´n ƒëang online
    db.ref("users/" + myId).set({ 
        ip: myIP, 
        name: name, 
        icon: dev.icon, 
        type: dev.type,
        lastSeen: Date.now() // Th√™m th·ªùi gian c·∫≠p nh·∫≠t ƒë·ªÉ ki·ªÉm tra
    });
}

UI.name.onchange = updateProfile;

fetch("https://api.ipify.org?format=json").then(r => r.json()).then(d => {
    myIP = d.ip;
    db.ref("users/" + myId).onDisconnect().remove();
    updateProfile();
    UI.status.innerText = "S·∫µn s√†ng (IP: " + d.ip + ")";
    db.ref("users").on("value", snap => {
        UI.devices.innerHTML = "";
        snap.forEach(u => {
            if (u.key !== myId && u.val().ip === d.ip) {
                const v = u.val();
                const div = document.createElement('div');
                div.className = 'device-item';
                div.innerHTML = `<div class="device-info"><div class="device-icon">${v.icon}</div><div class="device-name-text"><b>${v.name}</b><span>${v.type} (#${u.key})</span></div></div><span>‚ûî</span>`;
                div.onclick = () => {
                    targetId = u.key;
                    startConnect(u.key);
                };
                UI.devices.appendChild(div);
            }
        });
    });
});

db.ref("signal/" + myId).on("value", snap => {
    if (!snap.exists()) return;
    const m = snap.val();
    targetId = m.from; // L∆∞u l·∫°i ID ng∆∞·ªùi g·ª≠i signal
    if (!peer) { 
        peer = new SimplePeer({ initiator: false, trickle: false }); 
        bindEvents(); 
    }
    peer.signal(m.data);
    db.ref("signal/" + myId).remove();
});

function startConnect(tid) {
    if (peer) {
        // N·∫øu ƒë√£ c√≥ k·∫øt n·ªëi, ki·ªÉm tra file v√† g·ª≠i lu√¥n
        if (UI.file.files.length > 0) handleMultiSender(UI.file.files);
        else alert("Vui l√≤ng ch·ªçn file!");
        return;
    }
    UI.status.innerText = "ƒêang k·∫øt n·ªëi...";
    peer = new SimplePeer({ initiator: true, trickle: false });
    bindEvents();
}

function bindEvents() {
    peer.on('signal', d => db.ref("signal/" + targetId).set({ from: myId, data: d }));
    
    peer.on('connect', () => {
        UI.status.innerText = "‚úÖ ƒê√£ k·∫øt n·ªëi!";
        UI.status.style.color = "var(--success)";
        // N·∫øu m√°y n√†y l√† ng∆∞·ªùi ch·ªß ƒë·ªông nh·∫•n k·∫øt n·ªëi V√Ä c√≥ file th√¨ g·ª≠i lu√¥n
        if (UI.file.files.length > 0 && peer.initiator) {
            handleMultiSender(UI.file.files);
        }
    });

    peer.on('data', async d => {
        const h = d[0], p = d.slice(1);
        if (h === 2) { 
            meta = JSON.parse(new TextDecoder().decode(p));
            receivedSize = 0; startTime = Date.now();
            UI.prog.style.display = "block";
            UI.curFile.innerText = "üì• ƒêang nh·∫≠n: " + meta.name;
            UI.bar.style.background = "var(--primary)";
            UI.bar.style.width = "0%";
            window.chunks = [];
        } else if (h === 1) { 
            window.chunks.push(p);
            receivedSize += p.length;
            if (receivedSize % (1024*1024) < 131072) updateUI(receivedSize, meta.size);
        } else if (h === 3) {

			force100UI(`üéâ ƒê√£ nh·∫≠n xong: ${meta.name}`);
			const blob = new Blob(window.chunks);
			window.chunks = [];
			if (window.AndroidApp && typeof window.AndroidApp.saveFileToAndroid === 'function') {
				const reader = new FileReader();
				reader.readAsDataURL(blob); 
				reader.onloadend = function() {
					const base64data = reader.result.split(',')[1]; 
					window.AndroidApp.saveFileToAndroid(base64data, meta.name);
				};
			} else {
				// N·∫øu ch·∫°y tr√™n tr√¨nh duy·ªát th∆∞·ªùng
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = meta.name;
				a.click();
			}
			setTimeout(() => peer.send(new Uint8Array([4])), 500);

		} else if (h === 4) { 
				isNextReady = true;
			}
		});

    peer.on('close', () => { peer = null; UI.status.innerText = "M·∫•t k·∫øt n·ªëi"; });
    peer.on('error', err => { peer = null; console.error(err); });
}

async function handleMultiSender(files) {
    if (!peer || !peer.connected) return alert("Ch∆∞a c√≥ k·∫øt n·ªëi!");
    UI.prog.style.display = "block";
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        isNextReady = false;
        UI.curFile.innerText = `üì§ [${i+1}/${files.length}] ${file.name}`;
        UI.status.innerText = `ƒêang g·ª≠i file ${i+1}/${files.length}`;
        UI.bar.style.background = "var(--primary)";
        UI.bar.style.width = "0%";

        const m = new TextEncoder().encode(JSON.stringify({name: file.name, size: file.size}));
        const mp = new Uint8Array(m.length + 1); mp[0] = 2; mp.set(m, 1);
        peer.send(mp);

        startTime = Date.now();
        const reader = file.stream().getReader();
        let sent = 0;
        peer._channel.bufferedAmountLowThreshold = 4 * 1024 * 1024;

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            for (let j = 0; j < value.length; j += 131072) {
                if (peer._channel.bufferedAmount > 4 * 1024 * 1024) {
                    await new Promise(r => { peer._channel.onbufferedamountlow = () => { peer._channel.onbufferedamountlow = null; r(); }; });
                }
                const c = value.slice(j, j + 131072);
                const pkt = new Uint8Array(c.length + 1); pkt[0] = 1; pkt.set(c, 1);
                peer.send(pkt);
                sent += c.length;
                updateUI(sent, file.size);
            }
        }

        await new Promise(r => {
            const ck = setInterval(() => {
                if (peer._channel.bufferedAmount === 0) {
                    peer.send(new Uint8Array([3])); 
                    clearInterval(ck); r();
                }
            }, 100);
        });

        UI.status.innerText = "‚è≥ ƒê·ª£i x√°c nh·∫≠n t·ª´ m√°y nh·∫≠n...";
        while (!isNextReady) { await new Promise(r => setTimeout(r, 100)); }
        force100UI(`‚úÖ ƒê√£ g·ª≠i xong: ${file.name}`);
        await new Promise(r => setTimeout(r, 800));
    }
    UI.status.innerText = "üéâ G·ª≠i th√†nh c√¥ng!";
}

function updateUI(curr, total) {
    const p = Math.min(99, Math.floor(curr / total * 100));
    UI.bar.style.width = p + "%";
    UI.percent.innerText = p + "%";
    const s = (Date.now() - startTime) / 1000;
    UI.speed.innerText = (curr / 1024 / 1024 / (s || 1)).toFixed(1) + " MB/s";
}

function force100UI(msg) {
    UI.bar.style.transition = "width 0.3s ease-out";
    UI.bar.style.width = "100%";
    UI.percent.innerText = "100%";
    UI.bar.style.background = "var(--success)";
    UI.status.innerText = msg;
    if (navigator.vibrate) navigator.vibrate(100);
}

UI.file.onchange = () => {
    const fs = UI.file.files;
    if (fs.length > 0) {
        UI.fileInfo.innerText = `ƒê√£ ch·ªçn ${fs.length} file (${(Array.from(fs).reduce((a,b)=>a+b.size,0)/1024/1024).toFixed(1)} MB)`;
        // T·ª∞ ƒê·ªòNG G·ª¨I N·∫æU ƒê√É K·∫æT N·ªêI S·∫¥N
        if (peer && peer.connected) handleMultiSender(fs);
    }
};

setInterval(() => {
    if (myIP) {
        // C·∫≠p nh·∫≠t l·∫°i th·ªùi gian s·ªëng c·ªßa m√¨nh tr√™n Firebase
        updateProfile();
        
        // Th√¥ng b√°o tr·∫°ng th√°i nh·∫π nh√†ng ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt app v·∫´n ƒëang qu√©t
        console.log("ƒêang t·ª± ƒë·ªông qu√©t thi·∫øt b·ªã...");
    }
}, 3000);
</script>
</body>
</html>