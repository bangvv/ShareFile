<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Local Send File Pro - Stream Save</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/simple-peer@9/simplepeer.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #3b82f6; --primary-hover: #2563eb; --success: #10b981; --bg: #0b0f1a; --card: rgba(30, 41, 59, 0.75); --text: #f8fafc; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; position: fixed; background: radial-gradient(circle at 50% 0%, #1e293b 0%, #0b0f1a 100%); color: var(--text); display: flex; align-items: center; justify-content: center; }
        .card { width: 100%; max-width: 480px; max-height: 95vh; background: var(--card); padding: 24px; border-radius: 32px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; flex-direction: column; }
        h2 { margin: 0 0 15px; font-size: 1.4rem; background: linear-gradient(135deg, #93c5fd, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center; font-weight: 800; flex-shrink: 0; }
        #status-text { text-align: center; font-size: 0.8rem; font-weight: 600; margin-bottom: 10px; padding: 10px; border-radius: 12px; background: rgba(59, 130, 246, 0.1); color: var(--primary); }
        .name-box { margin-bottom: 15px; position: relative; flex-shrink: 0; }
        .name-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .name-box input { width: 100%; background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; color: white; padding: 12px 15px 12px 40px; border-radius: 14px; outline: none; font-size: 16px; }
        .device-list { margin-bottom: 15px; display: grid; gap: 10px; overflow-y: auto; padding-right: 5px; flex-grow: 1; }
        .device-item { padding: 16px; background: #0f172a; border-radius: 16px; border: 1px solid #334155; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: 0.2s; }
        .device-item:active { transform: scale(0.97); }
        .device-info { display: flex; align-items: center; gap: 15px; }
        .device-icon { font-size: 1.8rem; background: #1e293b; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
        .file-box { border: 2px dashed #475569; padding: 15px; text-align: center; border-radius: 20px; background: rgba(255,255,255,0.02); margin-top: auto; flex-shrink: 0; }
        .btn-upload { background: var(--primary); color: white; padding: 14px; border-radius: 14px; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; }
        #fileInput { display: none; }
        .progress-container { display: none; margin-top: 15px; background: #0f172a; padding: 15px; border-radius: 18px; border: 1px solid #334155; }
        .progress-bg { width: 100%; height: 10px; background: #334155; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        .progress-bar { width: 0%; height: 100%; background: var(--primary); transition: width 0.1s linear; }
        .stats { display: flex; justify-content: space-between; font-family: monospace; font-size: 0.85rem; }
    </style>
</head>
<body>

<div class="card">
    <h2><i class="fas fa-paper-plane"></i> Local Send Pro</h2>
    
    <div class="name-box">
        <i class="fas fa-user"></i>
        <input type="text" id="userName" placeholder="T√™n c·ªßa b·∫°n..." maxlength="20">
    </div>
    
    <div id="status-text"><i class="fas fa-wifi"></i> ƒêang kh·ªüi t·∫°o...</div>
    
    <div class="device-list" id="devices"></div>

    <div class="file-box">
        <div id="file-info" style="font-size: 0.75rem; margin-bottom: 8px;">Ch·ªçn file ƒë·ªÉ g·ª≠i</div>
        <label class="btn-upload">
            <i class="fas fa-cloud-upload-alt"></i> Ch·ªçn File
            <input type="file" id="fileInput" multiple>
        </label>
    </div>

    <div class="progress-container" id="progCont">
        <div id="cur-file" style="font-size: 0.75rem; color: var(--primary); overflow: hidden; text-overflow: ellipsis;"></div>
        <div class="progress-bg"><div class="progress-bar" id="bar"></div></div>
        <div class="stats">
            <span id="percent">0%</span>
            <span id="speed">0.0 MB/s</span>
        </div>
    </div>
</div>

<script src="firebase-config.js"></script>

<script>
const myId = Math.random().toString(36).slice(2, 8);
let myIP = "", peer = null, targetId = null;
let startTime = 0, meta = null, receivedSize = 0, isNextReady = false;

// Bi·∫øn cho t√≠nh nƒÉng Stream Save
let writableStream = null;
let receivedChunks = []; // D·ª± ph√≤ng cho tr√¨nh duy·ªát c≈©

const UI = {
    status: document.getElementById('status-text'),
    devices: document.getElementById('devices'),
    file: document.getElementById('fileInput'),
    bar: document.getElementById('bar'),
    percent: document.getElementById('percent'),
    speed: document.getElementById('speed'),
    prog: document.getElementById('progCont'),
    name: document.getElementById('userName'),
    curFile: document.getElementById('cur-file'),
    fileInfo: document.getElementById('file-info')
};

// --- Kh·ªüi t·∫°o v√† Firebase ---
const getDevInfo = () => {
    const ua = navigator.userAgent;
    if (/android/i.test(ua)) return { icon: "ü§ñ", type: "Android" };
    if (/iPad|iPhone|iPod/.test(ua)) return { icon: "üçé", type: "iPhone" };
    return { icon: "üíª", type: "PC" };
};
const dev = getDevInfo();
UI.name.value = localStorage.getItem('lan_name') || (dev.type + " " + myId);

async function updateProfile() {
    if (!myIP || !db) return;
    const name = UI.name.value || (dev.type + " " + myId);
    localStorage.setItem('lan_name', name);
    db.ref("users/" + myId).set({ ip: myIP, name: name, icon: dev.icon, type: dev.type, lastSeen: Date.now() });
}

fetch("https://api.ipify.org?format=json").then(r => r.json()).then(d => {
    myIP = d.ip;
    db.ref("users/" + myId).onDisconnect().remove();
    updateProfile();
    UI.status.innerText = "S·∫µn s√†ng: " + d.ip;
    
    db.ref("users").on("value", snap => {
        UI.devices.innerHTML = "";
        snap.forEach(u => {
            if (u.key !== myId && u.val().ip === d.ip) {
                const v = u.val();
                const div = document.createElement('div');
                div.className = 'device-item';
                div.innerHTML = `<div class="device-info"><div class="device-icon">${v.icon}</div><div><b>${v.name}</b><br><small>${v.type}</small></div></div><span>‚ûî</span>`;
                div.onclick = () => { targetId = u.key; startConnect(u.key); };
                UI.devices.appendChild(div);
            }
        });
    });
});

// --- WebRTC Logic ---
db.ref("signal/" + myId).on("value", snap => {
    if (!snap.exists()) return;
    const m = snap.val();
    targetId = m.from;
    if (!peer) { peer = new SimplePeer({ initiator: false, trickle: false }); bindEvents(); }
    peer.signal(m.data);
    db.ref("signal/" + myId).remove();
});

function startConnect(tid) {
    if (peer) { handleMultiSender(UI.file.files); return; }
    UI.status.innerText = "K·∫øt n·ªëi...";
    peer = new SimplePeer({ initiator: true, trickle: false });
    bindEvents();
}

function bindEvents() {
    peer.on('signal', d => db.ref("signal/" + targetId).set({ from: myId, data: d }));
    peer.on('connect', () => { 
        UI.status.innerText = "‚úÖ ƒê√£ k·∫øt n·ªëi"; 
        if (UI.file.files.length > 0 && peer.initiator) handleMultiSender(UI.file.files);
    });

    peer.on('data', async d => {
        const h = d[0], p = d.slice(1);
        
        // h=2: Nh·∫≠n Metadata
        if (h === 2) {
            meta = JSON.parse(new TextDecoder().decode(p));
            receivedSize = 0; startTime = Date.now();
            UI.prog.style.display = "block";
            UI.curFile.innerText = "üì• Nh·∫≠n: " + meta.name;
            
            // TH·ª¨ NGHI·ªÜM STREAM SAVE (CH·ªà D√ÄNH CHO TR√åNH DUY·ªÜT H·ªñ TR·ª¢)
            if (window.showSaveFilePicker) {
                try {
                    const handle = await window.showSaveFilePicker({ suggestedName: meta.name });
                    writableStream = await handle.createWritable();
                } catch (e) { writableStream = null; receivedChunks = []; }
            } else {
                receivedChunks = [];
            }
        } 
        // h=1: Nh·∫≠n Chunks
        else if (h === 1) {
            if (writableStream) {
                await writableStream.write(p); // Ghi th·∫≥ng xu·ªëng ƒëƒ©a, RAM kh√¥ng tƒÉng
            } else {
                receivedChunks.push(p); // Fallback cho mobile (d√πng RAM)
            }
            receivedSize += p.length;
            if (receivedSize % (1024*1024) < 131072) updateUI(receivedSize, meta.size);
        } 
        // h=3: Ho√†n t·∫•t
        else if (h === 3) {
            if (writableStream) {
                await writableStream.close();
                writableStream = null;
            } else {
                const blob = new Blob(receivedChunks);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = meta.name; a.click();
                receivedChunks = [];
            }
            force100UI(`Xong: ${meta.name}`);
            setTimeout(() => peer.send(new Uint8Array([4])), 500);
        } 
        // h=4: S·∫µn s√†ng cho file ti·∫øp theo
        else if (h === 4) { isNextReady = true; }
    });
}

// --- Logic g·ª≠i file (Streaming Reader) ---
async function handleMultiSender(files) {
    if (!peer || !peer.connected || files.length === 0) return;
    UI.prog.style.display = "block";
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        isNextReady = false;
        UI.curFile.innerText = `üì§ [${i+1}/${files.length}] ${file.name}`;
        
        const m = new TextEncoder().encode(JSON.stringify({name: file.name, size: file.size}));
        const mp = new Uint8Array(m.length + 1); mp[0] = 2; mp.set(m, 1);
        peer.send(mp);

        startTime = Date.now();
        const reader = file.stream().getReader();
        let sent = 0;
        peer._channel.bufferedAmountLowThreshold = 2 * 1024 * 1024;

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            // Chia nh·ªè chunk 64KB ƒë·ªÉ truy·ªÅn WebRTC ·ªïn ƒë·ªãnh
            for (let j = 0; j < value.length; j += 65536) {
                if (peer._channel.bufferedAmount > 4 * 1024 * 1024) {
                    await new Promise(r => { peer._channel.onbufferedamountlow = () => { peer._channel.onbufferedamountlow = null; r(); }; });
                }
                const c = value.slice(j, j + 65536);
                const pkt = new Uint8Array(c.length + 1); pkt[0] = 1; pkt.set(c, 1);
                peer.send(pkt);
                sent += c.length;
                updateUI(sent, file.size);
            }
        }

        // ƒê·ª£i b·ªô ƒë·ªám tr·ªëng ho√†n to√†n tr∆∞·ªõc khi b√°o k·∫øt th√∫c
        while(peer._channel.bufferedAmount > 0) { await new Promise(r => setTimeout(r, 100)); }
        peer.send(new Uint8Array([3]));
        
        while (!isNextReady) { await new Promise(r => setTimeout(r, 100)); }
    }
    UI.status.innerText = "üéâ G·ª≠i th√†nh c√¥ng!";
}

function updateUI(curr, total) {
    const p = Math.floor(curr / total * 100);
    UI.bar.style.width = p + "%";
    UI.percent.innerText = p + "%";
    const s = (Date.now() - startTime) / 1000;
    UI.speed.innerText = (curr / 1024 / 1024 / (s || 1)).toFixed(1) + " MB/s";
}

function force100UI(msg) {
    UI.bar.style.width = "100%";
    UI.percent.innerText = "100%";
    UI.status.innerText = msg;
}

UI.file.onchange = () => {
    const fs = UI.file.files;
    if (fs.length > 0) {
        UI.fileInfo.innerText = `ƒê√£ ch·ªçn ${fs.length} file`;
        if (peer && peer.connected) handleMultiSender(fs);
    }
};

setInterval(updateProfile, 5000);
</script>
</body>
</html>