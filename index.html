<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAN File Transfer Ultra</title>
    <script src="https://unpkg.com/simple-peer@9/simplepeer.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root { --p: #2563eb; --bg: #0f172a; --card: #1e293b; --txt: #f8fafc; }
        body { background: var(--bg); color: var(--txt); font-family: sans-serif; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { width: 100%; max-width: 500px; background: var(--card); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .status { background: rgba(37,99,235,0.1); color: #60a5fa; padding: 10px; border-radius: 10px; text-align: center; font-size: 0.9rem; margin: 15px 0; border: 1px solid rgba(37,99,235,0.2); }
        .device-item { background: #334155; padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .device-item:hover { background: #475569; }
        .progress-box { display: none; margin-top: 20px; padding: 15px; background: #0f172a; border-radius: 12px; }
        .bar-bg { width: 100%; height: 10px; background: #334155; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        .bar-fill { width: 0%; height: 100%; background: var(--p); transition: width 0.1s; }
        .btn-select { display: block; width: 100%; background: var(--p); color: white; text-align: center; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        input[type="file"] { display: none; }
        input[type="text"] { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <h3 style="margin-top:0">üöÄ LAN Transfer Pro</h3>
    
    <input type="text" id="userName" placeholder="Nh·∫≠p t√™n thi·∫øt b·ªã...">
    <div id="stt" class="status">ƒêang kh·ªüi t·∫°o m·∫°ng...</div>

    <div id="devices"></div>

    <div style="margin-top: 20px;">
        <div id="fileInfo" style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 5px;">Ch∆∞a ch·ªçn file</div>
        <label class="btn-select">
            üìÅ CH·ªåN FILE G·ª¨I
            <input type="file" id="fileInp" multiple>
        </label>
    </div>

    <div class="progress-box" id="pBox">
        <div id="fName" style="font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
        <div class="bar-bg"><div class="bar-fill" id="bar"></div></div>
        <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
            <span id="pct">0%</span>
            <span id="spd">0 MB/s</span>
        </div>
    </div>
</div>

<script src="firebase-config.js"></script>

<script>
const myId = Math.random().toString(36).substring(2, 8);
let peer = null, targetId = null, myIP = "";
let wStream = null, chunks = [], startTime = 0;

const UI = {
    stt: document.getElementById('stt'),
    devs: document.getElementById('devices'),
    name: document.getElementById('userName'),
    file: document.getElementById('fileInp'),
    pBox: document.getElementById('pBox'),
    bar: document.getElementById('bar'),
    pct: document.getElementById('pct'),
    spd: document.getElementById('spd'),
    fName: document.getElementById('fName')
};

UI.name.value = localStorage.getItem('lan_n') || "Device-" + myId;

// 1. L·∫•y IP v√† K·∫øt n·ªëi Firebase
fetch("https://api.ipify.org?format=json").then(r => r.json()).then(d => {
    myIP = d.ip;
    UI.stt.innerText = "S·∫µn s√†ng (LAN: " + d.ip + ")";
    
    const ref = db.ref("users/" + myId);
    ref.onDisconnect().remove();
    
    const update = () => {
        localStorage.setItem('lan_n', UI.name.value);
        ref.set({ ip: myIP, name: UI.name.value, last: Date.now() });
    };
    UI.name.onchange = update;
    update();

    db.ref("users").on("value", s => {
        UI.devs.innerHTML = "";
        s.forEach(u => {
            if (u.key !== myId && u.val().ip === myIP) {
                const d = document.createElement('div');
                d.className = 'device-item';
                d.innerHTML = `<span><b>${u.val().name}</b></span> <span>G·ª≠i ‚ûî</span>`;
                d.onclick = () => { targetId = u.key; connect(u.key); };
                UI.devs.appendChild(d);
            }
        });
    });
});

// 2. T√≠n hi·ªáu WebRTC
db.ref("sig/" + myId).on("value", s => {
    if (!s.exists()) return;
    const m = s.val();
    targetId = m.f;
    if (!peer) { peer = new SimplePeer({ initiator: false, trickle: false }); bind(); }
    peer.signal(m.d);
    db.ref("sig/" + myId).remove();
});

function connect(tid) {
    if (peer) { sendFiles(); return; }
    UI.stt.innerText = "ƒêang k·∫øt n·ªëi...";
    peer = new SimplePeer({ initiator: true, trickle: false });
    bind();
}

function bind() {
    peer.on('signal', d => db.ref("sig/" + targetId).set({ f: myId, d: d }));
    peer.on('connect', () => { 
        UI.stt.innerText = "‚úÖ ƒê√£ k·∫øt n·ªëi"; 
        if (UI.file.files.length > 0) sendFiles();
    });

    peer.on('data', async data => {
        const type = data[0], payload = data.slice(1);
        
        if (type === 2) { // Metadata
            const meta = JSON.parse(new TextDecoder().decode(payload));
            UI.pBox.style.display = "block";
            UI.fName.innerText = "üì• ƒêang nh·∫≠n: " + meta.n;
            startTime = Date.now();
            
            // CHI·∫æN THU·∫¨T L∆ØU: ∆Øu ti√™n Stream, n·∫øu kh√¥ng h·ªó tr·ª£ th√¨ d√πng RAM (cho Mobile)
            if (window.showSaveFilePicker) {
                try {
                    const h = await window.showSaveFilePicker({ suggestedName: meta.n });
                    wStream = await h.createWritable();
                } catch(e) { wStream = null; chunks = []; }
            } else { wStream = null; chunks = []; }
            peer.send(new Uint8Array([5])); // B√°o ƒë√£ s·∫µn s√†ng nh·∫≠n
        } 
        else if (type === 1) { // Chunks
            if (wStream) await wStream.write(payload);
            else chunks.push(payload);
            updateUI(payload.length, 0, true); 
        } 
        else if (type === 3) { // K·∫øt th√∫c
            if (wStream) { await wStream.close(); wStream = null; }
            else {
                const b = new Blob(chunks);
                const a = document.createElement('a');
                a.href = URL.createObjectURL(b); a.download = "received_file"; a.click();
                chunks = [];
            }
            UI.stt.innerText = "üéâ ƒê√£ nh·∫≠n xong!";
            peer.send(new Uint8Array([4]));
        }
    });
}

// 3. G·ª≠i File (T·ªëi ∆∞u cho m√°y 32-bit & File c·ª±c l·ªõn)
async function sendFiles() {
    const fs = UI.file.files;
    UI.pBox.style.display = "block";
    
    for (let f of fs) {
        UI.fName.innerText = "üì§ ƒêang g·ª≠i: " + f.name;
        const meta = new TextEncoder().encode(JSON.stringify({n: f.name, s: f.size}));
        const mPkt = new Uint8Array(meta.length + 1); mPkt[0] = 2; mPkt.set(meta, 1);
        peer.send(mPkt);

        // ƒê·ª£i m√°y nh·∫≠n ch·ªçn ch·ªó l∆∞u
        await new Promise(r => { 
            const check = (d) => { if(d[0]===5){ peer.off('data', check); r(); } };
            peer.on('data', check);
        });

        const reader = f.stream().getReader();
        let sent = 0;
        startTime = Date.now();

        // PHANH B·ªò NH·ªö: Gi·ªõi h·∫°n 512KB cho m√°y 32-bit
        peer._channel.bufferedAmountLowThreshold = 256 * 1024; 

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            for (let i = 0; i < value.length; i += 16384) { // M·ªói g√≥i 16KB
                if (peer._channel.bufferedAmount > 512 * 1024) {
                    await new Promise(r => { peer._channel.onbufferedamountlow = () => { peer._channel.onbufferedamountlow = null; r(); }; });
                }
                const c = value.slice(i, i + 16384);
                const p = new Uint8Array(c.length + 1); p[0] = 1; p.set(c, 1);
                peer.send(p);
                sent += c.length;
                updateUI(sent, f.size);
            }
        }
        
        while(peer._channel.bufferedAmount > 0) await new Promise(r => setTimeout(r, 100));
        peer.send(new Uint8Array([3]));
        await new Promise(r => { const c=(d)=>{if(d[0]===4){peer.off('data',c); r();}}; peer.on('data',c); });
    }
    UI.stt.innerText = "‚úÖ G·ª≠i t·∫•t c·∫£ th√†nh c√¥ng!";
}

let totalReceived = 0;
function updateUI(curr, total, isRecv = false) {
    if(isRecv) {
        totalReceived += curr;
        UI.pct.innerText = (totalReceived / 1024 / 1024).toFixed(1) + " MB";
    } else {
        const p = Math.floor(curr / total * 100);
        UI.bar.style.width = p + "%";
        UI.pct.innerText = p + "%";
    }
    const sec = (Date.now() - startTime) / 1000;
    UI.spd.innerText = ( (isRecv?totalReceived:curr) / 1024 / 1024 / (sec || 1)).toFixed(1) + " MB/s";
}

UI.file.onchange = () => { UI.fileInfo.innerText = "ƒê√£ ch·ªçn " + UI.file.files.length + " file"; };
</script>
</body>
</html>