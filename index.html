<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Local Send File Pro | Chuy·ªÉn File P2P T·ªëc ƒê·ªô Cao</title>
    <meta name="description" content="G·ª≠i file kh√¥ng gi·ªõi h·∫°n dung l∆∞·ª£ng qua m·∫°ng n·ªôi b·ªô v√† Internet. B·∫£o m·∫≠t P2P, t·ªëc ƒë·ªô cao, kh√¥ng c·∫ßn c√†i ƒë·∫∑t.">
    <meta name="keywords" content="g·ª≠i file nhanh, chuy·ªÉn d·ªØ li·ªáu, p2p file transfer, local send, g·ª≠i file l·ªõn">
    <meta name="author" content="LocalSendPro">
    
    <link rel="icon" type="image/png" href="image/icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://unpkg.com/simple-peer@9/simplepeer.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --primary: #3b82f6; 
            --primary-hover: #2563eb;
            --success: #10b981; 
            --bg: #0f172a; 
            --card: rgba(30, 41, 59, 0.7); 
            --text: #f1f5f9; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', system-ui, -apple-system, sans-serif; }

        body { 
            background: radial-gradient(circle at top center, #1e293b 0%, #0f172a 100%); 
            color: var(--text); 
            display: flex; 
            flex-direction: column;
            align-items: center;
            padding: 20px; 
            margin: 0; 
            min-height: 100vh;
        }

        .card { 
            width: 100%; 
            max-width: 480px; 
            background: var(--card); 
            padding: 30px; 
            border-radius: 28px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(12px);
            margin-top: 20px;
        }

        h2 { 
            margin: 0 0 25px; 
            font-size: 1.6rem; 
            background: linear-gradient(to right, #60a5fa, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center; 
            font-weight: 800; 
            letter-spacing: -1px;
        }

        .name-box { margin-bottom: 25px; position: relative; }
        .name-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #64748b; }
        .name-box input { 
            width: 100%; 
            background: rgba(15, 23, 42, 0.6); 
            border: 1px solid #334155; 
            color: white; 
            padding: 14px 15px 14px 45px; 
            border-radius: 14px; 
            outline: none; 
            font-size: 1rem; 
            transition: 0.3s; 
        }
        .name-box input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }

        #status-text { 
            text-align: center; 
            font-size: 0.85rem; 
            font-weight: 600; 
            margin-bottom: 20px; 
            padding: 12px; 
            border-radius: 12px; 
            background: rgba(59, 130, 246, 0.1); 
            color: var(--primary); 
            animation: pulse 2s infinite;
        }
		
		#status-devices { 
            text-align: center; 
            font-size: 0.85rem; 
            font-weight: 600; 
            margin-bottom: 20px; 
            padding: 12px; 
            border-radius: 12px; 
            background: rgba(59, 130, 246, 0.1); 
            color: var(--primary); 
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }

        .device-list { margin-bottom: 25px; display: grid; gap: 12px; }
        .device-item { 
            padding: 16px; 
            background: rgba(15, 23, 42, 0.5); 
            border-radius: 18px; 
            border: 1px solid #334155; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            cursor: pointer; 
            transition: 0.2s ease; 
        }
        .device-item:hover { background: rgba(51, 65, 85, 0.6); transform: translateY(-2px); border-color: var(--primary); }
        .device-info { display: flex; align-items: center; gap: 15px; }
        .device-icon { 
            font-size: 1.4rem; 
            background: #1e293b; 
            width: 45px; 
            height: 45px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 12px; 
            color: var(--primary);
        }
        .device-name-text b { display: block; font-size: 1rem; color: #fff; }
        .device-name-text span { font-size: 0.75rem; color: #94a3b8; }

        .file-box { 
            border: 2px dashed #475569; 
            padding: 30px 20px; 
            text-align: center; 
            border-radius: 24px; 
            margin-bottom: 20px; 
            background: rgba(255,255,255,0.03); 
            transition: 0.3s;
        }
        .file-box:hover { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
        #file-info { font-size: 0.85rem; color: #94a3b8; margin-bottom: 15px; }

        .btn-upload { 
            background: var(--primary); 
            color: white; 
            padding: 16px; 
            border-radius: 14px; 
            cursor: pointer; 
            font-weight: 700; 
            display: flex; 
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%; 
            transition: 0.3s;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
        }
        .btn-upload:hover { background: var(--primary-hover); transform: scale(1.02); }
        #fileInput { display: none; }

        .progress-container { 
            display: none; 
            margin-top: 25px; 
            background: #0f172a; 
            padding: 20px; 
            border-radius: 20px; 
            border: 1px solid #334155; 
        }
        .progress-bg { width: 100%; height: 10px; background: #334155; border-radius: 5px; overflow: hidden; margin-bottom: 12px; }
        .progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); transition: width 0.1s linear; }
        .stats { display: flex; justify-content: space-between; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: #94a3b8; }
        
        /* Footer SEO */
        .footer-info {
            max-width: 480px;
            margin-top: 40px;
            text-align: center;
            font-size: 0.8rem;
            color: #64748b;
            line-height: 1.6;
        }
    </style>
</head>
<body>

<div class="card">
    <h2><i class="fas fa-paper-plane"></i> Local Send Pro</h2>
    
    <div class="name-box">
        <i class="fas fa-user"></i>
        <input type="text" id="userName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." maxlength="20">
    </div>
	
	<div id="status-text"><i class="fas fa-circle-notch fa-spin"></i> ƒêang ki·ªÉm tra IP</div>
	
    <div id="status-devices"><i class="fas fa-circle-notch fa-spin"></i> ƒêang t√¨m ki·∫øm thi·∫øt b·ªã xung quanh...</div>
    
    <div class="device-list" id="devices">
        <div class="device-item">

        </div>
    </div>

    <div class="file-box">
        <div id="file-info"><i class="fas fa-info-circle"></i> Ch·ªçn file ƒë·ªÉ b·∫Øt ƒë·∫ßu chia s·∫ª</div>
        <label class="btn-upload">
            <i class="fas fa-cloud-upload-alt"></i> CH·ªåN FILE G·ª¨I NGAY
            <input type="file" id="fileInput" multiple>
        </label>
    </div>

    <div class="progress-container" id="progCont">
        <div id="cur-file" style="font-size: 0.8rem; margin-bottom: 8px; color: var(--primary);">file_name.zip</div>
        <div class="progress-bg"><div class="progress-bar" id="bar"></div></div>
        <div class="stats">
            <span id="percent">0%</span>
            <span id="speed"><i class="fas fa-bolt"></i> 0.0 MB/s</span>
        </div>
    </div>
</div>

<div class="footer-info">
    <p><b>Local Send File Pro</b> - Gi·∫£i ph√°p chuy·ªÉn d·ªØ li·ªáu P2P b·∫£o m·∫≠t.<br>
    Kh√¥ng l∆∞u tr·ªØ file tr√™n server, t·ªëc ƒë·ªô truy·ªÅn t·∫£i t·ªëi ƒëa theo ƒë∆∞·ªùng truy·ªÅn m·∫°ng c·ªßa b·∫°n.</p>
</div>

<script src="firebase-config.js"></script>

<script>
const myId = Math.random().toString(36).slice(2, 8);
let myIP = "", peer = null, startTime = 0, meta = null, receivedSize = 0, isNextReady = false;

const UI = {
    status: document.getElementById('status-text'),
    devices: document.getElementById('devices'),
    file: document.getElementById('fileInput'),
    bar: document.getElementById('bar'),
    percent: document.getElementById('percent'),
    speed: document.getElementById('speed'),
    prog: document.getElementById('progCont'),
    name: document.getElementById('userName'),
    curFile: document.getElementById('cur-file')
};

// Nh·∫≠n di·ªán thi·∫øt b·ªã
const getDevice = () => {
    const ua = navigator.userAgent;
    if (/android/i.test(ua)) return { icon: "ü§ñ", type: "Android" };
    if (/iPad|iPhone|iPod/.test(ua)) return { icon: "üçé", type: "iPhone" };
    if (/Windows/i.test(ua)) return { icon: "üíª", type: "Windows PC" };
    return { icon: "üåê", type: "Thi·∫øt b·ªã" };
};
const dev = getDevice();
UI.name.value = localStorage.getItem('lan_name') || (dev.type + " " + myId);

function updateProfile() {
    if (!myIP) return;
    localStorage.setItem('lan_name', UI.name.value);
    db.ref("users/" + myId).set({ ip: myIP, name: UI.name.value, icon: dev.icon, type: dev.type });
}
UI.name.onchange = updateProfile;

fetch("https://api.ipify.org?format=json").then(r => r.json()).then(d => {
    myIP = d.ip;
    db.ref("users/" + myId).onDisconnect().remove();
    updateProfile();
    UI.status.innerText = "S·∫µn s√†ng (IP: " + d.ip + ")";
    db.ref("users").on("value", snap => {
        UI.devices.innerHTML = "";
        snap.forEach(u => {
            if (u.key !== myId && u.val().ip === d.ip) {
                const v = u.val();
                const div = document.createElement('div');
                div.className = 'device-item';
                div.innerHTML = `<div class="device-info"><div class="device-icon">${v.icon}</div><div class="device-name-text"><b>${v.name}</b><span>${v.type} (#${u.key})</span></div></div><span>‚ûî</span>`;
                div.onclick = () => startConnect(u.key);
                UI.devices.appendChild(div);
            }
        });
    });
});

// --- SIGNALING ---
db.ref("signal/" + myId).on("value", snap => {
    if (!snap.exists()) return;
    const m = snap.val();
    if (!peer) { peer = new SimplePeer({ initiator: false, trickle: false }); bindEvents(m.from); }
    peer.signal(m.data);
    db.ref("signal/" + myId).remove();
});

function startConnect(tid) {
    if (UI.file.files.length === 0) return alert("Ch·ªçn file tr∆∞·ªõc!");
    UI.status.innerText = "ƒêang k·∫øt n·ªëi...";
    peer = new SimplePeer({ initiator: true, trickle: false });
    bindEvents(tid);
}

function bindEvents(tid) {
    peer.on('signal', d => db.ref("signal/" + tid).set({ from: myId, data: d }));
    peer.on('connect', () => {
        UI.status.innerText = "‚úÖ ƒê√£ k·∫øt n·ªëi!";
        if (UI.file.files.length > 0 && peer.initiator) handleMultiSender(UI.file.files);
    });
    peer.on('data', async d => {
        const h = d[0], p = d.slice(1);
        if (h === 2) { // Nh·∫≠n Meta
            meta = JSON.parse(new TextDecoder().decode(p));
            receivedSize = 0; startTime = Date.now();
            UI.prog.style.display = "block";
            UI.curFile.innerText = "üì• ƒêang nh·∫≠n: " + meta.name;
            UI.bar.style.background = "var(--primary)";
            window.chunks = [];
        } else if (h === 1) { // Nh·∫≠n Data
            window.chunks.push(p);
            receivedSize += p.length;
            if (receivedSize % (1024*1024) < 131072) updateUI(receivedSize, meta.size);
        } else if (h === 3) { // K·∫øt th√∫c 1 file
            force100UI(`üéâ ƒê√£ nh·∫≠n xong file!`);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob(window.chunks));
            a.download = meta.name; a.click();
            setTimeout(() => peer.send(new Uint8Array([4])), 500); // B√°o m√°y g·ª≠i: ƒê√£ l∆∞u xong!
        } else if (h === 4) { // M√°y nh·∫≠n ƒë√£ s·∫µn s√†ng file ti·∫øp theo
            isNextReady = true;
        }
    });
}

// --- LOGIC G·ª¨I NHI·ªÄU FILE ---
async function handleMultiSender(files) {
    UI.prog.style.display = "block";
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        isNextReady = false;
        UI.curFile.innerText = `üì§ [${i+1}/${files.length}] ${file.name}`;
        UI.status.innerText = `ƒêang g·ª≠i file ${i+1}/${files.length}`;
        UI.bar.style.background = "var(--primary)";
        UI.bar.style.width = "0%";

        const m = new TextEncoder().encode(JSON.stringify({name: file.name, size: file.size}));
        const mp = new Uint8Array(m.length + 1); mp[0] = 2; mp.set(m, 1);
        peer.send(mp);

        startTime = Date.now();
        const reader = file.stream().getReader();
        let sent = 0;
        peer._channel.bufferedAmountLowThreshold = 4 * 1024 * 1024;

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            for (let j = 0; j < value.length; j += 131072) {
                if (peer._channel.bufferedAmount > 4 * 1024 * 1024) {
                    await new Promise(r => { peer._channel.onbufferedamountlow = () => { peer._channel.onbufferedamountlow = null; r(); }; });
                }
                const c = value.slice(j, j + 131072);
                const pkt = new Uint8Array(c.length + 1); pkt[0] = 1; pkt.set(c, 1);
                peer.send(pkt);
                sent += c.length;
                updateUI(sent, file.size);
            }
        }

        // Ch·ªù d·ªØ li·ªáu bay ƒëi h·∫øt
        await new Promise(r => {
            const ck = setInterval(() => {
                if (peer._channel.bufferedAmount === 0) {
                    peer.send(new Uint8Array([3])); 
                    clearInterval(ck); r();
                }
            }, 100);
        });

        // Ch·ªù m√°y nh·∫≠n b·∫•m L∆∞u xong m·ªõi ƒë∆∞·ª£c hi·ªán 100% v√† qua file m·ªõi
        UI.status.innerText = "‚è≥ ƒê·ª£i m√°y nh·∫≠n x√°c nh·∫≠n...";
        while (!isNextReady) { await new Promise(r => setTimeout(r, 100)); }

        force100UI(`‚úÖ ƒê√£ g·ª≠i xong file ${i+1}`);
        await new Promise(r => setTimeout(r, 800)); // Ngh·ªâ x√≠u cho ƒë·∫πp
    }
    UI.status.innerText = "üéâ HO√ÄN T·∫§T T·∫§T C·∫¢ 100%!";
    UI.status.style.color = "var(--success)";
}

function updateUI(curr, total) {
    const p = Math.min(99, Math.floor(curr / total * 100));
    UI.bar.style.width = p + "%";
    UI.percent.innerText = p + "%";
    const s = (Date.now() - startTime) / 1000;
    UI.speed.innerText = (curr / 1024 / 1024 / (s || 1)).toFixed(1) + " MB/s";
}

function force100UI(msg) {
    UI.bar.style.transition = "width 0.3s ease-out";
    UI.bar.style.width = "100%";
    UI.percent.innerText = "100%";
    UI.bar.style.background = "var(--success)";
    UI.status.innerText = msg;
    if (navigator.vibrate) navigator.vibrate(100);
}

UI.file.onchange = () => {
    const fs = UI.file.files;
    if (fs.length > 0) UI.fileInfo.innerText = `ƒê√£ ch·ªçn ${fs.length} file (${(Array.from(fs).reduce((a,b)=>a+b.size,0)/1024/1024).toFixed(1)} MB)`;
};
UI.fileInfo = document.getElementById('file-info');
</script>
</body>
</html>