<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LAN Turbo - Pro Multi</title>
    <script src="https://unpkg.com/simple-peer@9/simplepeer.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #3b82f6; --success: #10b981; --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 15px; margin: 0; }
        .card { width: 100%; max-width: 450px; background: var(--card); padding: 25px; border-radius: 24px; border: 1px solid #334155; box-shadow: 0 20px 40px rgba(0,0,0,0.4); margin-top: 10px; }
        h2 { margin: 0 0 20px; font-size: 1.5rem; color: var(--primary); text-align: center; font-weight: 800; letter-spacing: -0.5px; }
        
        .name-box { margin-bottom: 20px; }
        .name-box input { width: 100%; background: #0f172a; border: 2px solid #334155; color: white; padding: 12px 15px; border-radius: 12px; outline: none; font-size: 1rem; transition: 0.3s; }
        .name-box input:focus { border-color: var(--primary); }

        #status-text { text-align: center; font-size: 0.85rem; font-weight: 700; margin-bottom: 20px; padding: 10px; border-radius: 12px; background: rgba(59, 130, 246, 0.1); color: var(--primary); transition: 0.3s; }

        .device-list { margin-bottom: 20px; display: grid; gap: 12px; }
        .device-item { padding: 16px; background: #0f172a; border-radius: 16px; border: 1px solid #334155; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: 0.2s; }
        .device-item:active { transform: scale(0.97); background: #1e293b; }
        .device-info { display: flex; align-items: center; gap: 15px; }
        .device-icon { font-size: 1.8rem; background: #1e293b; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
        .device-name-text b { display: block; font-size: 1rem; color: #fff; }
        .device-name-text span { font-size: 0.75rem; color: #64748b; }

        .file-box { border: 2px dashed #475569; padding: 25px; text-align: center; border-radius: 20px; margin-bottom: 20px; background: rgba(255,255,255,0.02); }
        #file-info { font-size: 0.85rem; color: #94a3b8; margin-bottom: 15px; font-style: italic; }
        .btn-upload { background: var(--primary); color: white; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 700; display: block; width: 100%; text-align: center; }
        
        .progress-container { display: none; margin-top: 25px; background: #0f172a; padding: 20px; border-radius: 18px; border: 1px solid #334155; }
        .progress-bg { width: 100%; height: 12px; background: #334155; border-radius: 6px; overflow: hidden; margin-bottom: 12px; }
        .progress-bar { width: 0%; height: 100%; background: var(--primary); border-radius: 6px; transition: width 0.1s linear; }
        .stats { display: flex; justify-content: space-between; font-family: monospace; font-size: 0.95rem; font-weight: 700; }
        #cur-file { font-size: 0.8rem; color: var(--primary); margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    </style>
</head>
<body>

<div class="card">
    <h2>Local Send File Pro</h2>
    
    <div class="name-box">
        <input type="text" id="userName" placeholder="T√™n hi·ªÉn th·ªã..." maxlength="20">
    </div>

    <div id="status-text">ƒêang kh·ªüi t·∫°o...</div>
    <div class="device-list" id="devices"></div>

    <div class="file-box">
        <div id="file-info">Ch∆∞a ch·ªçn file n√†o</div>
        <label class="btn-upload">üìÇ CH·ªåN FILE (NHI·ªÄU) <input type="file" id="fileInput" multiple></label>
    </div>

    <div class="progress-container" id="progCont">
        <div id="cur-file"></div>
        <div class="progress-bg"><div class="progress-bar" id="bar"></div></div>
        <div class="stats">
            <span id="percent">0%</span>
            <span id="speed">0.0 MB/s</span>
        </div>
    </div>
</div>

<script src="firebase-config.js"></script>

<script>
const myId = Math.random().toString(36).slice(2, 8);
let myIP = "", peer = null, startTime = 0, meta = null, receivedSize = 0, isNextReady = false;

const UI = {
    status: document.getElementById('status-text'),
    devices: document.getElementById('devices'),
    file: document.getElementById('fileInput'),
    bar: document.getElementById('bar'),
    percent: document.getElementById('percent'),
    speed: document.getElementById('speed'),
    prog: document.getElementById('progCont'),
    name: document.getElementById('userName'),
    curFile: document.getElementById('cur-file')
};

// Nh·∫≠n di·ªán thi·∫øt b·ªã
const getDevice = () => {
    const ua = navigator.userAgent;
    if (/android/i.test(ua)) return { icon: "ü§ñ", type: "Android" };
    if (/iPad|iPhone|iPod/.test(ua)) return { icon: "üçé", type: "iPhone" };
    if (/Windows/i.test(ua)) return { icon: "üíª", type: "Windows PC" };
    return { icon: "üåê", type: "Thi·∫øt b·ªã" };
};
const dev = getDevice();
UI.name.value = localStorage.getItem('lan_name') || (dev.type + " " + myId);

function updateProfile() {
    if (!myIP) return;
    localStorage.setItem('lan_name', UI.name.value);
    db.ref("users/" + myId).set({ ip: myIP, name: UI.name.value, icon: dev.icon, type: dev.type });
}
UI.name.onchange = updateProfile;

fetch("https://api.ipify.org?format=json").then(r => r.json()).then(d => {
    myIP = d.ip;
    db.ref("users/" + myId).onDisconnect().remove();
    updateProfile();
    UI.status.innerText = "S·∫µn s√†ng (IP: " + d.ip + ")";
    db.ref("users").on("value", snap => {
        UI.devices.innerHTML = "";
        snap.forEach(u => {
            if (u.key !== myId && u.val().ip === d.ip) {
                const v = u.val();
                const div = document.createElement('div');
                div.className = 'device-item';
                div.innerHTML = `<div class="device-info"><div class="device-icon">${v.icon}</div><div class="device-name-text"><b>${v.name}</b><span>${v.type} (#${u.key})</span></div></div><span>‚ûî</span>`;
                div.onclick = () => startConnect(u.key);
                UI.devices.appendChild(div);
            }
        });
    });
});

// --- SIGNALING ---
db.ref("signal/" + myId).on("value", snap => {
    if (!snap.exists()) return;
    const m = snap.val();
    if (!peer) { peer = new SimplePeer({ initiator: false, trickle: false }); bindEvents(m.from); }
    peer.signal(m.data);
    db.ref("signal/" + myId).remove();
});

function startConnect(tid) {
    if (UI.file.files.length === 0) return alert("Ch·ªçn file tr∆∞·ªõc!");
    UI.status.innerText = "ƒêang k·∫øt n·ªëi...";
    peer = new SimplePeer({ initiator: true, trickle: false });
    bindEvents(tid);
}

function bindEvents(tid) {
    peer.on('signal', d => db.ref("signal/" + tid).set({ from: myId, data: d }));
    peer.on('connect', () => {
        UI.status.innerText = "‚úÖ ƒê√£ k·∫øt n·ªëi!";
        if (UI.file.files.length > 0 && peer.initiator) handleMultiSender(UI.file.files);
    });
    peer.on('data', async d => {
        const h = d[0], p = d.slice(1);
        if (h === 2) { // Nh·∫≠n Meta
            meta = JSON.parse(new TextDecoder().decode(p));
            receivedSize = 0; startTime = Date.now();
            UI.prog.style.display = "block";
            UI.curFile.innerText = "üì• ƒêang nh·∫≠n: " + meta.name;
            UI.bar.style.background = "var(--primary)";
            window.chunks = [];
        } else if (h === 1) { // Nh·∫≠n Data
            window.chunks.push(p);
            receivedSize += p.length;
            if (receivedSize % (1024*1024) < 131072) updateUI(receivedSize, meta.size);
        } else if (h === 3) { // K·∫øt th√∫c 1 file
            force100UI(`üéâ ƒê√£ nh·∫≠n xong file!`);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob(window.chunks));
            a.download = meta.name; a.click();
            setTimeout(() => peer.send(new Uint8Array([4])), 500); // B√°o m√°y g·ª≠i: ƒê√£ l∆∞u xong!
        } else if (h === 4) { // M√°y nh·∫≠n ƒë√£ s·∫µn s√†ng file ti·∫øp theo
            isNextReady = true;
        }
    });
}

// --- LOGIC G·ª¨I NHI·ªÄU FILE ---
async function handleMultiSender(files) {
    UI.prog.style.display = "block";
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        isNextReady = false;
        UI.curFile.innerText = `üì§ [${i+1}/${files.length}] ${file.name}`;
        UI.status.innerText = `ƒêang g·ª≠i file ${i+1}/${files.length}`;
        UI.bar.style.background = "var(--primary)";
        UI.bar.style.width = "0%";

        const m = new TextEncoder().encode(JSON.stringify({name: file.name, size: file.size}));
        const mp = new Uint8Array(m.length + 1); mp[0] = 2; mp.set(m, 1);
        peer.send(mp);

        startTime = Date.now();
        const reader = file.stream().getReader();
        let sent = 0;
        peer._channel.bufferedAmountLowThreshold = 4 * 1024 * 1024;

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            for (let j = 0; j < value.length; j += 131072) {
                if (peer._channel.bufferedAmount > 4 * 1024 * 1024) {
                    await new Promise(r => { peer._channel.onbufferedamountlow = () => { peer._channel.onbufferedamountlow = null; r(); }; });
                }
                const c = value.slice(j, j + 131072);
                const pkt = new Uint8Array(c.length + 1); pkt[0] = 1; pkt.set(c, 1);
                peer.send(pkt);
                sent += c.length;
                updateUI(sent, file.size);
            }
        }

        // Ch·ªù d·ªØ li·ªáu bay ƒëi h·∫øt
        await new Promise(r => {
            const ck = setInterval(() => {
                if (peer._channel.bufferedAmount === 0) {
                    peer.send(new Uint8Array([3])); 
                    clearInterval(ck); r();
                }
            }, 100);
        });

        // Ch·ªù m√°y nh·∫≠n b·∫•m L∆∞u xong m·ªõi ƒë∆∞·ª£c hi·ªán 100% v√† qua file m·ªõi
        UI.status.innerText = "‚è≥ ƒê·ª£i m√°y nh·∫≠n x√°c nh·∫≠n...";
        while (!isNextReady) { await new Promise(r => setTimeout(r, 100)); }

        force100UI(`‚úÖ ƒê√£ g·ª≠i xong file ${i+1}`);
        await new Promise(r => setTimeout(r, 800)); // Ngh·ªâ x√≠u cho ƒë·∫πp
    }
    UI.status.innerText = "üéâ HO√ÄN T·∫§T T·∫§T C·∫¢ 100%!";
    UI.status.style.color = "var(--success)";
}

function updateUI(curr, total) {
    const p = Math.min(99, Math.floor(curr / total * 100));
    UI.bar.style.width = p + "%";
    UI.percent.innerText = p + "%";
    const s = (Date.now() - startTime) / 1000;
    UI.speed.innerText = (curr / 1024 / 1024 / (s || 1)).toFixed(1) + " MB/s";
}

function force100UI(msg) {
    UI.bar.style.transition = "width 0.3s ease-out";
    UI.bar.style.width = "100%";
    UI.percent.innerText = "100%";
    UI.bar.style.background = "var(--success)";
    UI.status.innerText = msg;
    if (navigator.vibrate) navigator.vibrate(100);
}

UI.file.onchange = () => {
    const fs = UI.file.files;
    if (fs.length > 0) UI.fileInfo.innerText = `ƒê√£ ch·ªçn ${fs.length} file (${(Array.from(fs).reduce((a,b)=>a+b.size,0)/1024/1024).toFixed(1)} MB)`;
};
UI.fileInfo = document.getElementById('file-info');
</script>
</body>
</html>